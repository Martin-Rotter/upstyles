\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{updiplom}[2012/09/09 UP Diploma Style]
\PackageWarningNoLine{updiplom}{[updiplom] You are using updiplom style 0.8}

\RequirePackage{kvoptions}

\SetupKeyvalOptions {
	family=upd,
	prefix=upd@
}

% Parametry.
\DeclareBoolOption{master}
\DeclareStringOption[utf8]{encoding}[utf8]
\DeclareStringOption[utf8]{bibencoding}[utf8]
\DeclareStringOption[czech]{language}[czech]
\DeclareStringOption[false]{printversion}[false]
\DeclareStringOption[true]{joinlists}[true]
\DeclareStringOption[true]{figures}[true]
\DeclareStringOption[true]{tables}[true]
\DeclareStringOption[false]{theorems}[false]
\DeclareStringOption[false]{sourcecodes}[false]
\DeclareStringOption[false]{glossaries}[false]

%% Nerozpoznaný parametr hodí chybu.
\DeclareDefaultOption{\PackageWarningNoLine{updiplom}{[updiplom] Option '\CurrentOption' was not recognized}}

\ProcessKeyvalOptions*

\RequirePackage[
joinlists=\upd@joinlists,
encoding=\upd@encoding,
bibencoding=\upd@bibencoding,
language=\upd@language,
printversion=\upd@printversion,
joinlists=\upd@joinlists,
figures=\upd@figures,
tables=\upd@tables,
glossaries=\upd@glossaries,
sourcecodes=\upd@sourcecodes,
theorems=\upd@theorems
]{upbase}

% Nastavení geometrie papíru.
\RequirePackage[
paper=a4paper,
driver=pdftex,
top=3.5cm,
left=4cm,
bottom=3.5cm,
width=1.05\textwidth
]{geometry}

\ifthenelse{\boolean{@twoside}}{
  \PackageError{updiplom}{Two-sided document mode is not allowed for updiplom}
}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Nastavení dynamických textů.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% čeština
\ifthenelse{\equal{\upb@language}{czech}} {
\newcommand{\uptextsupervisor}{Vedouc\'i pr\'ace: }
\newcommand{\uptextanot}{Anotace}
\newcommand{\uptextthx}{Pod\v ekov\'an\'i}
\newcommand{\uptextfield}{Studijn\'i obor: }
\newcommand{\uptextdefaultfield}{Aplikovan\'a informatika}


\ifthenelse{\boolean{upd@master}} {
\def\@uppaper{DIPLOMOV\'A PR\'ACE}
} {
\def\@uppaper{BAKAL\'A\v RSK\'A PR\'ACE}
}
} {
\relax
}

% angličtina
\ifthenelse{\equal{\upb@language}{english}} {
\newcommand{\uptextsupervisor}{Supervisor: }
\newcommand{\uptextanot}{Annotation}
\newcommand{\uptextthx}{Thanks to}
\newcommand{\uptextfield}{Field: }
\newcommand{\uptextdefaultfield}{Applied computer science}


\ifthenelse{\boolean{upd@master}} {
\def\@uppaper{MASTER'S THESIS}
} {
\def\@uppaper{BACHELOR'S THESIS}
}
} {
\relax
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Závěry.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment{upconclusions}[1][czech]{
\cleardoublepage
\bgroup
\ifthenelse{\equal{#1}{czech}} {
\phantomsection
\addcontentsline{toc}{section}{Z\'av\v er}
\section*{Z\'av\v er}
}
%% else branch stands for english conclusions
{
\phantomsection
\addcontentsline{toc}{section}{Conclusions}
\section*{Conclusions}
}
\begin{otherlanguage}{#1}
} {
\end{otherlanguage}
\egroup
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% titlepage implementation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\thanks#1{\gdef\@thanks{#1}}
\def\annotation#1{\gdef\@annotation{#1}}

%% hacking wrong page numbering
\let\oldsetcounter=\setcounter
\renewcommand\setcounter[2]{%
  \def\tempa{#1}%
  \def\tempb{page}%
  \ifx\tempa\tempb\else\oldsetcounter{#1}{#2}\fi}

\def\title#1{\gdef\@title{#1}}
\def\subtitle#1{\gdef\@subtitle{#1}}
\def\yearofsubmit#1{\gdef\@yearofsubmit{#1}}
\def\author#1{\gdef\@author{#1}}
\def\supervisor#1{\gdef\@supervisor{#1}}
\def\field#1{\gdef\@field{#1}}

% defaulty
\subtitle{}
\thanks{}
\field{\uptextdefaultfield}
\yearofsubmit{\the\year}

\def\maketitle{
\hypertarget{up:paper}{}
\bookmark[dest=up:paper]{\@title}
\setcounter{page}{1}
\begin{titlepage}
\hypertarget{up:title}{}
\bookmark[
 rellevel=1,
 keeplevel,
 dest=up:title
]{\uptexttitle}
\begin{center}
{\large \uptexttitletop \par
        \uptextdept \par}
\vfill
{\LARGE\bfseries{\@uppaper} \\}
\vfill
{\Large \@title \\[2em]\large\@subtitle}

\vfill
\centering
\includegraphics[width=2.5cm]{\uplogofile}
\vfill
{\noindent
\begin{tabular}{p{6cm} p{6cm}}
{\Large\@yearofsubmit} \\[1em]
\uptextsupervisor\@supervisor
\end{tabular}
\hfill
\begin{tabular}{ll}
{\Large\@author} \\[1em]
\uptextfield\@field
\end{tabular}}
\end{center}
\end{titlepage}

% tiskne dvě strany s anotací a poděkováním
\cleardoublepage
\thispagestyle{empty}
\null\vfill
\hypertarget{up:anotation}{}
\bookmark[
 rellevel=1,
 keeplevel,
 dest=up:anotation
]{\uptextanot}
\begin{center}
\textbf{\uptextanot}
\end{center}
\bigskip
\emph{\@annotation}
\vfill\null
\ifthenelse{\equal{\@thanks}{}} {
\relax
} {
\cleardoublepage
\thispagestyle{empty}
\vspace*{\fill}
\hypertarget{up:thx}{}
\bookmark[
 rellevel=1,
 keeplevel,
 dest=up:thx
]{\uptextthx}
\noindent\@thanks
}

% tiskne obsah a seznamy obrázku, tabulek a případně zdr. kódů, více v makrech \uptableofcontents a \upprintlists
\tableofcontents
\upprintlists
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% specific hyperref
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
\AtBeginDocument{
\hypersetup{
  pdftitle={\@title\ (\@uppaper)},    % title
  pdfauthor={\@author\ (\uptextsupervisor\@supervisor)},     % author
  pdfsubject={\@title\ (\@uppaper)},   % subject of the document
  pdfcreator={\@author},   % creator of the document
}
}
\makeatother