\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{updiplom}[2012/09/09 UP Diploma Style]
\PackageWarningNoLine{updiplom}{[updiplom] You are using updiplom style 0.72}

\RequirePackage{kvoptions}

\SetupKeyvalOptions {
	family=upd,
	prefix=upd@
}

% TODO: Nahazet sem parametry a poctivě dělit.
\DeclareBoolOption{master}
\DeclareStringOption[utf8]{encoding}[utf8]
\DeclareStringOption[utf8]{bibencoding}[utf8]
\DeclareStringOption[czech]{language}[czech]
\DeclareStringOption[false]{printversion}[false]
\DeclareStringOption[true]{joinlists}[true]
\DeclareStringOption[true]{figures}[true]
\DeclareStringOption[true]{tables}[true]
\DeclareStringOption[false]{sourcecodes}[false]
\DeclareStringOption[false]{glossaries}[false]

%% Nerozpoznaný parametr hodí chybu.
\DeclareDefaultOption{\PackageWarningNoLine{updiplom}{[updiplom] Option '\CurrentOption' was not recognized}}

\ProcessKeyvalOptions*

\RequirePackage[
	joinlists=\upd@joinlists,
	encoding=\upd@encoding,
	bibencoding=\upd@bibencoding,
	language=\upd@language,
	printversion=\upd@printversion,
	joinlists=\upd@joinlists,
	figures=\upd@figures,
	tables=\upd@tables,
	glossaries=\upd@glossaries,
	sourcecodes=\upd@sourcecodes
]{upbase}

\RequirePackage[
	paper=a4paper,
	driver=pdftex,
	top=2.5cm,
	left=3.5cm,
	bottom=2.0cm,
	width=1.15\textwidth
]{geometry}

\ifthenelse{\boolean{@twoside}}{
  \PackageError{updiplom}{Two-sided document mode is not allowed for updiplom}
}{}

%% nastavení textů
%% anaogicky přidat pro ostatní jazyky, aktuálně pouze čeština
\ifthenelse{\equal{\upb@language}{czech}} {
\newcommand{\uptextsupervisor}{Vedoucí práce: }
\newcommand{\uptextdipl}{Diplomant: }
\newcommand{\uptextfinish}{Rok odevzdání: }

\ifthenelse{\boolean{upd@master}} {
\def\@upthesis{DIPLOMOV\'A PR\'ACE}
} {
\def\@upthesis{BAKAL\'A\v RSK\'A PR\'ACE}
}
} {
\relax
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% conclusions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment{upconclusions}[1][czech]{
\cleardoublepage
\bgroup
\ifthenelse{\equal{#1}{czech}} {
\phantomsection
\addcontentsline{toc}{section}{Z\'av\v er}
\section*{Z\'av\v er}
}
%% else branch stands for english conclusions
{
\phantomsection
\addcontentsline{toc}{section}{Conclusions}
\section*{Conclusions}
}
\begin{otherlanguage}{#1}
} {
\end{otherlanguage}
\egroup
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% titlepage implementation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\thanks#1{\gdef\@thanks{#1}}
\def\annotation#1{\gdef\@annotation{#1}}

%% hacking wrong page numbering
\let\oldsetcounter=\setcounter
\renewcommand\setcounter[2]{%
  \def\tempa{#1}%
  \def\tempb{page}%
  \ifx\tempa\tempb\else\oldsetcounter{#1}{#2}\fi}

\def\title#1{\gdef\@title{#1}}
\def\subtitle#1{\gdef\@subtitle{#1}}
\def\yearoffinish#1{\gdef\@yearoffinish{#1}}
\def\author#1{\gdef\@author{#1}}
\def\supervisor#1{\gdef\@supervisor{#1}}
\def\class#1{\gdef\@class{#1}}

% defaulty
\subtitle{}
\thanks{}

\def\maketitle{
\hypertarget{up:thesis}{}
\bookmark[dest=up:thesis]{\@title}
\setcounter{page}{1}
\begin{titlepage}
\hypertarget{up:title}{}
\bookmark[
 rellevel=1,
 keeplevel,
 dest=up:title
]{\uptexttitle}
\begin{center}
{\large \uptexttitletop \par
        \uptextdept \par}
\vfill
{\LARGE\bfseries{\@upthesis} \\}
\vfill
{\Large \@title \\[1em]\@subtitle}

\vfill
\centering
\includegraphics[width=2.5cm]{\uplogofile}
\vfill
{\noindent
\begin{tabular}{ll}
\uptextsupervisor\\
{\bfseries\@supervisor} \\
\uptextfinish\@yearoffinish
\end{tabular}
\hfill
\begin{tabular}{ll}
\uptextdipl\\
{\bfseries\@author} \\
\@class
\end{tabular}}
\end{center}
\end{titlepage}

% tiskne dvě strany s anotací a poděkováním
\cleardoublepage
\thispagestyle{empty}
\null\vfill
\hypertarget{up:anotation}{}
\bookmark[
 rellevel=1,
 keeplevel,
 dest=up:anotation
]{\uptextanot}
\begin{center}
\textbf{\uptextanot}
\end{center}
\bigskip
\emph{\@annotation}
\vfill\null
\ifthenelse{\equal{\@thanks}{}} {
\relax
} {
\cleardoublepage
\thispagestyle{empty}
\vspace*{\fill}
\hypertarget{up:thx}{}
\bookmark[
 rellevel=1,
 keeplevel,
 dest=up:thx
]{\uptextthx}
\noindent\@thanks
}

% tiskne obsah a seznamy obrázku, tabulek a případně zdr. kódů, více v makrech \uptableofcontents a \upprintlists
\uptableofcontents
\ifthenelse{\equal{\upb@joinlists}{true}} {
\relax
} {
\cleardoublepage
}
\upprintlists
}

\newcommand{\upmakeendlists}{
% tiskne seznam zkratek
\ifthenelse{\equal{\upd@glossaries}{true}} {
\printglossary
} {
\relax
}

% tiskne seznam teorémů
\listoftheorems
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% specific hyperref
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
\AtBeginDocument{
\hypersetup{
  pdftitle={\@title\ (\@upthesis)},    % title
  pdfauthor={\@author\ (\uptextsupervisor\@supervisor)},     % author
  pdfsubject={\@title\ (\@upthesis)},   % subject of the document
  pdfcreator={\@author},   % creator of the document
}
}
\makeatother