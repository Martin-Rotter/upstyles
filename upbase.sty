\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{upbase}[2012/09/09 UP Base Style]
\PackageWarningNoLine{upbase}{[upbase] You are using upbase style 0.72}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% packages and arguments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{booktabs}
\RequirePackage{makeidx}
\RequirePackage{multicol}
\RequirePackage[unicode,pdftex]{hyperref}
\RequirePackage{ifpdf}
\RequirePackage{ifthen}
\RequirePackage{amsmath}
\RequirePackage{amsbsy}
\RequirePackage{amssymb}
\RequirePackage{amsthm}
\RequirePackage{euscript}
\RequirePackage[open,atend]{bookmark}
\RequirePackage{inconsolata}
\RequirePackage[usenames,dvipsnames,table]{xcolor}
\RequirePackage{appendix}
\RequirePackage{chngcntr}

\SetupKeyvalOptions {
	family=upb,
	prefix=upb@
}

\DeclareStringOption[false]{iwona}[false]
\DeclareStringOption[false]{printversion}[false]
\DeclareStringOption[false]{blacklogo}[false]
\DeclareStringOption[true]{joinlists}[true]
\DeclareStringOption[false]{figures}[false]
\DeclareStringOption[false]{tables}[false]
\DeclareStringOption[false]{sourcecodes}[false]
\DeclareStringOption[false]{theorems}[false]
\DeclareStringOption[false]{glossaries}[false]
\DeclareStringOption[czech]{language}[czech]
\DeclareStringOption[utf8]{bibencoding}[utf8]
\DeclareStringOption[numeric]{bibstyle}[numeric]
\DeclareStringOption[utf8]{encoding}[utf8]

%% Warn user about unknown parameters.
\DeclareDefaultOption{\PackageWarningNoLine{upbase}{[upbase] Option '\CurrentOption' was not recognized}}

\ProcessKeyvalOptions*

\RequirePackage[\upb@encoding]{inputenc}
\RequirePackage[czech,english,\upb@language]{babel}
\RequirePackage[autostyle=try]{csquotes}
\RequirePackage[savemem]{listings}
\RequirePackage[
	natbib,
	backend=bibtex,
	babel=other,
	bibencoding=\upb@bibencoding,
	style=\upb@bibstyle]{biblatex}

%% nastavení textů
%% anaogicky přidat pro ostatní jazyky, aktuálně pouze čeština
\ifthenelse{\equal{\upb@language}{czech}} {
\newcommand{\uptexttitle}{Tituln\'i strana}
\newcommand{\uptexttitletop}{P\v R\'IRODOV\v EDECK\'A FAKULTA UNIVERZITY PALACK\'EHO}
\newcommand{\uptextdept}{KATEDRA INFORMATIKY}
\newcommand{\uptextanot}{Anotace}
\newcommand{\uptextthx}{Pod\v ekov\'an\'i}
\newcommand{\uptextindex}{Rejstřík}
\newcommand{\buno}{bez \'ujmy na obecnosti}
\newcommand{\Buno}{Bez \'ujmy na obecnosti}
\renewcommand{\lstlistlistingname}{Seznam zdrojových k\'od\r{u}}
\renewcommand{\lstlistingname}{Zdrojov\'y k\'od}
\newcommand{\listtheoremname}{Seznam teor\'em\r{u}}

\newcommand{\uptextdefinition}{Definice}
\newcommand{\uptextlemma}{Lemma}
\newcommand{\uptextconsequence}{Důsledek}
\newcommand{\uptextremark}{Poznámka}
\newcommand{\uptexttheorem}{Věta}
\newcommand{\uptextprooof}{Důkaz}
\newcommand{\uptextexample}{Příklad}

%% macros for glossaries
\ifthenelse{\equal{\upb@glossaries}{true}} {
\RequirePackage[style=super,acronym,nonumberlist,sanitize=none]{glossaries}
\renewcommand{\acronymname}{Seznam zkratek}
} {
\relax
}

} {
\relax
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% iwona fonts package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifthenelse{\equal{\upb@iwona}{true}} {
\RequirePackage{iwona}
} {
\relax
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% graphicx package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifthenelse{\boolean{pdf}} {
\RequirePackage[pdftex]{graphicx}
} {
\RequirePackage{graphicx}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% abbreviations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifthenelse{\equal{\upb@glossaries}{true}} {
\makeglossaries

\renewcommand{\glsnamefont}[1]{\textbf{#1}}
\renewcommand{\glspostdescription}{}

\let\orgprintglossary=\printglossary

\renewcommand{\printglossary}{
\clearpage
\phantomsection
\addcontentsline{toc}{section}{\acronymname}
\orgprintglossary[type=\acronymtype]
}
} {
\relax
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% české závorky pro balík csquotes
%% použití: \enquote{citoslovce}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\DeclareQuoteStyle{czech}
  {\quotedblbase}
  {\textquotedblleft}
  {\textquoteleft}
  {\textquoteright}

\renewcommand{\uv}[1]{
\enquote{#1}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% index
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeindex

\let\orgtheindex=\theindex
\let\orgendtheindex=\endtheindex
\let\orgprintindex=\printindex

\def\indexcolumns{2}
\def\indexemph#1{{\itshape #1}}
\renewenvironment{theindex}{%
  \newpage
  \bgroup%
  \section*{\uptextindex%
    \@mkboth{\uptextindex}{\uptextindex}}%
  \addcontentsline{toc}{section}{\uptextindex}%
  \def\item{\par}%
  \def\subitem{\par---\kern1ex}%
  \def\subsubitem{\par---\kern1ex---\kern1ex}%
  \def\indexspace{\smallskip}%
  \setlength{\parindent}{-2em}%
  \setlength{\leftskip}{2em}%
  \begin{multicols*}{\indexcolumns}
  }{%
  \end{multicols*}
  \egroup
}

\renewcommand{\printindex}{
\clearpage
\phantomsection
\orgprintindex
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% colors
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\definecolor{halfgray}{gray}{0.55}
\definecolor{webgreen}{rgb}{0,.5,0}
\definecolor{webbrown}{rgb}{.6,0,0}
\definecolor{lightergray}{gray}{0.99}
\definecolor{ultragreen}{rgb}{40,180,10}
\definecolor{darkgray}{rgb}{60,60,60}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% fancy macros and misc opts
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% macros
\newcommand{\csharp}{C\kern-.03em\raise.38ex\hbox{\scriptsize{\#}}\ }
\newcommand{\cpp}{C\kern-.11em\raise.38ex\hbox{\scriptsize{++}}\ }
\newcommand{\keyword}[1]{{\ttfamily\color{darkgray}{#1}}}

%% appendix
\let\orgappendix=\appendix
\renewcommand{\appendix}{
\clearpage
%\addtocontents{toc}{\protect\vspace{10pt}}
\orgappendix
}

%% caption
\let\orgcaption=\caption
\renewcommand{\caption}[1]{
{\centering\orgcaption{#1}}
}

%% používá se pro obnovení PDF záložek na kořen
\newcommand{\upendofmainmatter}{
\bookmarksetup{startatroot}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% bibliography
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\let\orgprintbibliography=\printbibliography

\renewcommand{\printbibliography}{
\clearpage
\phantomsection
\addcontentsline{toc}{section}{\bibname}	% zřejmě netřeba překádat, babel se o vše postará
\orgprintbibliography
}

\setcounter{biburlnumpenalty}{9000}
\setcounter{biburlucpenalty}{9000}
\setcounter{biburllcpenalty}{9000}

\renewenvironment{thebibliography}[1]
{\section*{\refname
    \@mkboth{\MakeUppercase\refname}{\MakeUppercase\refname}}%
  \addcontentsline{toc}{section}{\refname}	% zřejmě netřeba překádat, babel se o vše postará
  \list{\@biblabel{\@arabic\c@enumiv}}%
  {\settowidth\labelwidth{\@biblabel{#1}}%
    \leftmargin\labelwidth
    \advance\leftmargin\labelsep
    \@openbib@code
    \usecounter{enumiv}%
    \let\p@enumiv\@empty
    \renewcommand\theenumiv{\@arabic\c@enumiv}}%
  \sloppy
  \clubpenalty4000
  \@clubpenalty \clubpenalty
  \widowpenalty4000%
  \sfcode`\.\@m}
{\def\@noitemerr
  {\@latex@warning{Empty `thebibliography' environment}}%
  \endlist}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% \paragraph macro fixes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\setcounter{tocdepth}{5}
\setcounter{secnumdepth}{5}
\newcommand{\subsubsubsection}{\@startsection{paragraph}{4}{0ex}%
   {-3.25ex plus -1ex minus -0.2ex}%
   {1.5ex plus 0.2ex}%
   {\normalfont\normalsize\bfseries}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% listings
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\lstdefinestyle{upbasestyle}{
	breaklines=true,
	flexiblecolumns=true,
	basicstyle=\footnotesize\ttfamily,
	keywordstyle=\bfseries,
	commentstyle=\color{gray},
	stringstyle=\color{black},
	numberbychapter=false,
	escapeinside={£*}{*£},
	%firstnumber=1,
	%numbers=left,
	%numbersep=10pt,
	inputencoding=utf8,
    numberstyle=\scriptsize\ttfamily,
    stepnumber=1,
    showstringspaces=false,
	tabsize=2,
	extendedchars=true,
    literate=
		{á}{{\'a}}1
        {í}{{\'i}}1
        {é}{{\'e}}1
        {ý}{{\'y}}1
        {ú}{{\'u}}1
        {ó}{{\'o}}1
        {ě}{{\v{e}}}1
        {š}{{\v{s}}}1
        {č}{{\v{c}}}1
        {ř}{{\v{r}}}1
        {ž}{{\v{z}}}1
        {ď}{{\v{d}}}1
        {ť}{{\v{t}}}1
        {ň}{{\v{n}}}1                
        {ů}{{\r{u}}}1
        {Á}{{\'A}}1
        {Í}{{\'I}}1
        {É}{{\'E}}1
        {Ý}{{\'Y}}1
        {Ú}{{\'U}}1
        {Ó}{{\'O}}1
        {Ě}{{\v{E}}}1
        {Š}{{\v{S}}}1
        {Č}{{\v{C}}}1
        {Ř}{{\v{R}}}1
        {Ž}{{\v{Z}}}1
        {Ď}{{\v{D}}}1
        {Ť}{{\v{T}}}1
        {Ň}{{\v{N}}}1                
        {Ů}{{\r{U}}}1    
}

\lstdefinelanguage{TutorialD}{morekeywords={tuple,matching,insert,divide,by,per,tclose,from,summarize,count,all,but,as,base,rename,prefix,extend,add,compose,union,minus,intersect,update,writeln,init,type,possrep,constraint,and,or,relation,where,base,drop},
	sensitive=false,
	morecomment=[s][commentstyle]{/*}{*/},
	morestring=[b][stringstyle]{"},
}

\lstdefinelanguage{text}{
	morekeywords={},
	sensitive=false,
}

\lstdefinelanguage{csharp}{
	morekeywords={int,ref,static,fixed,unsafe,public,private,protected,return,for,if,void},
	sensitive=false,
	morecomment=[s][commentstyle]{/*}{*/},
	morecomment=[l][commentstyle]{//},
	morestring=[b][stringstyle]{"},
}

\lstdefinelanguage{cpp}{
	morekeywords={int,static,bool,return,for,if,void,ifndef,define,endif,class,constexpr,new,const,auto,double,public,private,protected,signals,slots},
	sensitive=false,
	morecomment=[s][commentstyle]{/*}{*/},
	morecomment=[l][commentstyle]{//},
	morestring=[b][stringstyle]{"},
}

\lstloadlanguages{Lisp,SQL,TeX,Python,Java,TutorialD,text,csharp,cpp}

\newcommand{\upinlinecode}[3] {
\noindent\ignorespaces\lstinline[language=#1]#2#3#2\ignorespacesafterend
}

\lstnewenvironment{upcode}[3]{
\lstset{language=#1,style=upbasestyle,firstnumber=1,caption={#3},label={#2},aboveskip=10px,belowskip=15px}
}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% logos
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifthenelse{\equal{\upb@blacklogo}{true}} {
\def\uplogofile{graphics/uplogo-black}
} {
\def\uplogofile{graphics/uplogo-white}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% theorems
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{thmtools}

\declaretheoremstyle[
	headfont=\normalfont\bfseries,
	notefont=\normalfont\bfseries,
	bodyfont=\itshape,
	spaceabove=\parskip,
	spacebelow=\parskip,
	headpunct=:
]{upthmstyle}

\declaretheoremstyle[
	notefont=\bfseries,
	spaceabove=\parskip,
	spacebelow=\parskip,
	headpunct=:
]{updefstyle}


\declaretheoremstyle[
	headfont=\normalfont\scshape,
	notefont=\normalfont\scshape,
	spaceabove=\parskip,
	spacebelow=\parskip,
	headpunct=:
]{uprempstyle}

\declaretheoremstyle[
	headfont=\normalfont\scshape,
	notefont=\normalfont\scshape,
	spaceabove=\parskip,
	spacebelow=\parskip,
	qed=\qedsymbol,
	headpunct=:
]{upproofstyle}

\declaretheorem[within=section,style=updefstyle,numbered=yes,name=\uptextdefinition]{definition}
\declaretheorem[within=section,style=upthmstyle,numbered=yes,name=\uptextlemma]{lemma}
\declaretheorem[within=section,style=upthmstyle,numbered=yes,name=\uptextconsequence]{consequence}
\declaretheorem[within=section,style=uprempstyle,numbered=yes,name=\uptextremark]{remark}
\declaretheorem[within=section,style=uprempstyle,numbered=yes,name=\uptextexample]{example}
\declaretheorem[within=section,style=upthmstyle,numbered=yes,name=\uptexttheorem]{theorem}
\declaretheorem[style=upproofstyle,numbered=no,name=\uptextprooof]{prooof}

\let\orglistoftheorems=\listoftheorems

\renewcommand{\listoftheorems}{
\orglistoftheorems[ignoreall,show={definition,consequence,lemma,remark,theorem,prooof,example}]
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% hyperref
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifthenelse{\equal{\upb@printversion}{true}} {
\hypersetup {
colorlinks=false
}
} {
\hypersetup {
colorlinks=true
}
}

\hypersetup {
    linktocpage=true, pdfstartpage=1, pageanchor=true,
    pdfstartview=FitV, breaklinks=true, pdfpagemode=UseNone, 
    plainpages=false, bookmarksnumbered,
    hypertexnames=true, pdfhighlight=/O,
    urlcolor=webbrown, linkcolor=RoyalBlue, 
    citecolor=webgreen
}

\newcommand{\mail}[1]{\href{mailto:#1}{\texttt{#1}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% toc implementation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\let\orgtableofcontents=\tableofcontents

%% nové makro, protože je kolize s balíkem listings
\newcommand{\uptableofcontents}{
\cleardoublepage
\hypertarget{up:toc}{}
\bookmark[
 rellevel=1,
 keeplevel,
 dest=up:toc
]{\contentsname}
\orgtableofcontents
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% section-aware counters
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\counterwithin{equation}{section}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% lists implementation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\upprintlists{
\cleardoublepage
\ifthenelse{\equal{\upb@figures}{true}} {
\listoffigures
\ifthenelse{\equal{\upb@joinlists}{true}} {
\relax
} {
\clearpage
}
} {
\relax
}
\ifthenelse{\equal{\upb@tables}{true}} {
\listoftables
\ifthenelse{\equal{\upb@joinlists}{true}} {
\relax
} {
\clearpage
}
} {
\relax
}

\ifthenelse{\equal{\upb@theorems}{true}} {
\listoftheorems
\ifthenelse{\equal{\upb@joinlists}{true}} {
\relax
} {
\clearpage
}
} {
\relax
}

\ifthenelse{\equal{\upb@sourcecodes}{true}} {
\lstlistoflistings
\ifthenelse{\equal{\upb@joinlists}{true}} {
\relax
} {
\clearpage
}
} {
\relax
}
\cleardoublepage
}

\endinput